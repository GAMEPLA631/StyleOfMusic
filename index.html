<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Musical Universe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js Library for 3D Wallpaper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Inter:wght@400;700&display=swap');
        
        /* Basic body styles for a modern, dark look */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0a0a0a;
            color: #f0f0f0;
            line-height: 1.6;
            overflow-x: hidden;
            /* Dôležité: zabezpečuje, že obsah bude nad 3D tapetou */
            position: relative; 
            z-index: 1;
        }

        /* 3D Wallpaper Canvas Styles - celá obrazovka, fixné, za obsahom */
        #threejs-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Zabezpečuje, že je za obsahom */
            pointer-events: none; /* Umožňuje prekliknutie na obsah stránky */
            opacity: 0.5; /* Mierne stlmené, aby nebolo príliš rušivé */
        }
        
        /* Container for the entire page */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            position: relative; /* Pre zachovanie z-index 1 */
        }

        /* Hero section for an engaging introduction */
        .hero-section {
            background: linear-gradient(to right, #1a1a1a, #2c2c2c);
            padding: 6rem 2rem;
            border-radius: 1rem;
            text-align: center;
            margin-bottom: 3rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        /* Grid for genre cards */
        .genre-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }
        
        /* Styling and animation for genre cards */
        .genre-card {
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            transition: transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
            opacity: 0;
            transform: translateY(30px);
            border: 2px solid transparent;
            color: #ffffff; /* Zabezpečí, že text na kartách s gradientom je biely */
        }
        
        /* Color gradients for cards */
        .grad-1 { background-image: linear-gradient(135deg, #FF6B6B, #F88A6A); }
        .grad-2 { background-image: linear-gradient(135deg, #51A8E8, #7DE2D1); }
        .grad-3 { background-image: linear-gradient(135deg, #A87DFF, #D18CEB); }
        .grad-4 { background-image: linear-gradient(135deg, #F9D423, #F64F59); }
        .grad-5 { background-image: linear-gradient(135deg, #20E3B2, #6C5B7B); }
        .grad-6 { background-image: linear-gradient(135deg, #B993D6, #8CA6DB); }
        .grad-7 { background-image: linear-gradient(135deg, #FFDAB9, #FFC0CB); }
        .grad-8 { background-image: linear-gradient(135deg, #ff00cc, #333399); } 
        
        /* Animation when the card is visible */
        .genre-card.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Hover effect */
        .genre-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
            border-color: #8c7ae6;
        }

        .genre-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.75rem;
        }
        
        /* Špeciálne pre dlhé názvy štýlov */
        .genre-title.long {
            font-size: 1.1rem; 
        }

        .genre-description {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: #f0f0f0;
            line-height: 1.5;
            opacity: 0.8;
        }

        /* Chat section styles */
        .chat-section {
            background-color: #1a1a1a;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            margin-top: 3rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .chat-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .chat-box {
            height: 400px;
            overflow-y: auto;
            background-color: #0d0d0d;
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Hide scrollbar on WebKit browsers */
        .chat-box::-webkit-scrollbar {
            display: none;
        }

        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            white-space: pre-wrap;
            position: relative;
        }

        .message.user {
            background-color: #51A8E8;
            color: #1a1a1a;
            align-self: flex-end;
            text-align: right;
            border-bottom-right-radius: 0.25rem;
        }

        .message.ai {
            background-color: #2c2c2c;
            color: #f0f0f0;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .message-text {
            word-wrap: break-word;
        }

        .copy-button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #51A8E8;
            color: #1a1a1a;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
        }

        .copy-button:hover {
            background-color: #3f87c2;
            transform: translateY(-1px);
        }

        .copy-button.copied {
            background-color: #20E3B2;
        }

        .chat-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; /* Zväčšený margin pre lepšie oddelenie */
            gap: 1rem;
        }

        .model-toggle-button {
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap; 
            border: 2px solid transparent; /* Základný border pre všetky */
            flex-shrink: 0;
        }
        
        .model-toggle-button.standard {
            background-color: #3d3d3d;
            color: #f0f0f0;
            border-color: #51A8E8;
        }
        
        /* Nový štýl pre V4 Energy - Žltá/Oranžová Energia */
        .model-toggle-button.energy {
            background-color: #F9D423; 
            color: #1a1a1a;
            border-color: #F64F59;
            box-shadow: 0 0 10px rgba(249, 212, 35, 0.8);
        }


        .model-toggle-button.boosted {
            background-color: #FF6B6B; /* Červená farba pre BOOST */
            color: #1a1a1a;
            border-color: #F88A6A;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            background-color: #2c2c2c;
            border: 2px solid #3d3d3d;
            color: #f0f0f0;
            outline: none;
            transition: border-color 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .chat-input:focus {
            border-color: #51A8E8;
        }

        .generate-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #A87DFF, #D18CEB);
            color: #ffffff;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #A87DFF;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
            flex-shrink: 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Media Query for responsiveness */
        @media (max-width: 768px) {
            .hero-section {
                padding: 4rem 1rem;
            }
            .chat-title {
                font-size: 1.5rem;
            }
            .chat-controls-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .model-toggle-button {
                width: 100%;
            }
        }

        
    </style>
</head>
<body>
    <!-- 3D Background Canvas -->
    <canvas id="threejs-canvas"></canvas>

    <!-- Wallpaper Control Button - Z-index 20 zabezpečí, že bude vždy navrchu -->
    <button id="toggle-wallpaper" class="fixed bottom-4 right-4 z-20 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-full shadow-lg transition duration-300">
        Zmeniť Tapetu (Nebula)
    </button>
    
    <div class="container">
        <!-- Engaging hero section with title and subtitle -->
        <header class="hero-section">
            <h1 class="text-5xl md:text-6xl font-bold mb-4 text-white drop-shadow-md">The Musical Universe</h1>
            <p class="text-lg md:text-xl text-gray-300">Explore the endless palette of genres and their unique stories.</p>
        </header>

        <div class="genre-list" id="genre-container">
            <!-- Cards will be generated with JavaScript, each with its own description -->
        </div>

        <!-- Chat section -->
        <section class="chat-section">
            <h2 class="chat-title">Generate Music Lyrics with AI</h2>
            
            <!-- Nová riadiaca sekcia pre prepínanie modelov -->
            <div class="chat-controls-row">
                <!-- Tlačidlo sa inicializuje v JS -->
                <button id="model-toggle" class="model-toggle-button standard">
                    Aktuálny Model: V1
                </button>
                <button id="tts-button" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white font-bold rounded-full transition duration-300">
                    Prečítať Hlasom (TTS)
                </button>
            </div>
            
            <div id="chat-box" class="chat-box">
                <!-- Messages will appear here -->
            </div>
            <div class="chat-input-container">
                <input type="text" id="prompt-input" class="chat-input" placeholder="Enter your music genre or idea...">
                <button id="generate-button" class="generate-button">Generate</button>
                <div id="loading-spinner" class="loading-spinner"></div>
            </div>
        </section>
    </div>
    
    <audio id="audio-player" style="display:none;"></audio>


    <script>
        // Definovanie stavov modelu
        const MODEL_STATES = {
            STANDARD: 0, // V1 - Štandardné kreatívne
            ENERGY: 1,   // V4 Energy (EDM/Trap Energy)
            BOOSTED: 2   // V5 Pro (Bass Boosted / Silné Basy bez vulgarizmov)
        };

        const styles = [
            "Bass Boosted",
            "Horrorcore", "Dark Ambient", "Drone", "Industrial", "Gothic Metal", 
            "Doom Metal", "Black Metal", "Death Industrial", "Power Electronics", "Noise",
            "Bass Boosted Trap", "Future Bass Drop", "Hardstyle Bass", "Dubstep Wobble",
            "Vaporwave", "Synthwave", "Lofi Hip Hop", "Ambient", "Post-Rock", "Shoegaze",
            "Chillwave", "Trip Hop", "Reggaeton", "Jungle",
            "Ska Punk", "Gospel", "Celtic Music", "Minimalism", "Baroque Pop", "K-Pop", "Samba", "Flamenco", "Opera",
            // Energetické štýly
            "Hardcore Punk", "Drum and Bass", "Speedcore", "Power Metal",
            "Metalcore Dark", 
            "Aggressive Bass Boosted Energy",
            // NOVÉ ŠTÝLY ZADANÉ UŽÍVATEĽOM
            "Bass Boosted Hard",
            "Dark Horror Darkness" 
        ];

        const descriptions = {
            "Bass Boosted": "Music specifically mixed and mastered to be played on powerful car audio systems, with a focus on deep, rumbling bass.",
            "Horrorcore": "A blend of hip hop with horror themes, often featuring violent lyrics, eerie samples, and dark beats.",
            "Dark Ambient": "Minimalistic and atmospheric music that creates a sense of dread, desolation, and unease.",
            "Drone": "Music characterized by sustained tones or sound clusters, creating a hypnotic and often unsettling atmosphere.",
            "Industrial": "A genre using harsh, abrasive sounds, often created from industrial equipment and electronic loops, to create a tense and cold atmosphere.",
            "Gothic Metal": "A fusion of heavy metal with the dark, melancholic elements of gothic rock, including dramatic vocals and gloomy melodies.",
            "Doom Metal": "Extremely slow and heavy metal music known for its gloomy, oppressive, and pessimistic themes.",
            "Black Metal": "An extreme subgenre of metal defined by fast tempos, raw recording, and screeching vocals, often with themes of darkness and evil.",
            "Death Industrial": "A genre combining the harsh soundscapes of industrial music with the dark, morbid themes of death and decay.",
            "Power Electronics": "An extreme genre known for its distorted vocals and harsh, static noise, creating an aggressive and chaotic sound.",
            "Noise": "Music characterized by the use of dissonant and often unsettling sounds, focusing on the texture and quality of noise itself.",
            "Bass Boosted Trap": "A subgenre of Trap music where the primary focus is on extremely low-frequency sub-bass, often with distorted and heavy 808s.",
            "Future Bass Drop": "Characterized by its signature 'drop' and a heavy, melodic bass line, often featuring wobbles and digital synth sounds.",
            "Hardstyle Bass": "Known for its powerful and distorted kick drum, combined with raw, high-energy basslines that drive the track.",
            "Dubstep Wobble": "Defined by its iconic 'wobble bass' sound, which is created by modulating the bassline, providing a rhythmic and pulsating feel.",
            "Vaporwave": "A microgenre of electronic music with a nostalgic, surreal aesthetic, often incorporating slowed-down, pitch-shifted samples of smooth jazz and lounge music.",
            "Synthwave": "A retro-futuristic genre inspired by 1980s film soundtracks and video games, featuring synthesizers and a nostalgic, vibrant sound.",
            "Lofi Hip Hop": "A relaxing genre with muted, downtempo beats and often subtle background noise, ideal for studying or unwinding.",
            "Ambient": "A genre focused on atmosphere and tone over traditional musical structure, creating a sense of calm and space.",
            "Post-Rock": "Instrumental music that uses rock instrumentation and song structure but avoids typical rock conventions, focusing on building dramatic soundscapes.",
            "Shoegaze": "A subgenre of alternative rock characterized by a fusion of obscured vocals, distorted guitars, and overwhelming sound.",
            "Chillwave": "A style of electronic music with a lo-fi, hazy sound, often featuring relaxed rhythms and nostalgic synth melodies.",
            "Trip Hop": "A downtempo electronic genre that blends hip hop rhythms with a dark, cinematic, and atmospheric sound.",
            "Reggaeton": "A genre originating in Puerto Rico, blending Jamaican dancehall with Latin American and hip hop rhythms.",
            "Jungle": "A fast-paced genre of electronic music characterized by breakbeats, heavy basslines, and samples.",
            "Ska Punk": "A fusion of the energetic, upbeat rhythms of ska with the aggressive and fast-paced nature of punk rock.",
            "Gospel": "Music written to express personal or communal belief in Christian life, often featuring powerful vocals and spiritual themes.",
            "Celtic Music": "A broad genre encompassing traditional music from Celtic nations such as Ireland, Scotland, and Wales, known for its use of fiddles, flutes, and bagpipes.",
            "Minimalism": "Characterized by a repetitive, hypnotic feel, often using simple melodic and rhythmic ideas that are repeated and slowly changed over time.",
            "Baroque Pop": "A subgenre of pop and rock music that incorporates elements of classical music, such as strings, harpsichord, and multi-part vocal harmonies.",
            "K-Pop": "A form of popular music originating in South Korea, often featuring a blend of diverse genres like pop, hip hop, R&B, and EDM.",
            "Samba": "A Brazilian musical genre and dance style known for its rhythmic, lively beat and often celebratory themes.",
            "Flamenco": "A traditional Spanish art form involving soulful singing, intricate guitar playing, and passionate dance.",
            "Opera": "A dramatic stage work in which all or most of the text is sung, accompanied by an orchestra, combining music, theater, and sometimes dance.",
            // Popisy pre energetické štýly
            "Hardcore Punk": "Extrémne rýchly a agresívny subžáner punku, často s krátkymi piesňami a surovým zvukom.",
            "Drum and Bass": "Vysokoenergetický žáner elektronickej hudby, charakteristický rýchlymi bicími slučkami a hlbokými basmi.",
            "Speedcore": "Extrémne rýchly a intenzívny štýl elektronickej hudby, s tempom často presahujúcim 300 úderov za minútu.",
            "Power Metal": "Subžáner heavy metalu, známy pre svoje rýchle melódie, melodické vokaly a fantasy témy.",
            "Metalcore Dark": "A mix of heavy guitar riffs, fast drums, and melodic yet aggressive choruses, with screams/growls in the verses.",
            "Aggressive Bass Boosted Energy": "A chaotic fusion blending Brutal Bass, Dubstep, Hardstyle, Neurostep, and Ravecore. Defined by its heavy, dark, explosive sound for peak festival energy and chaos.",
            "Bass Boosted Hard": "Bass Boosted, EDM, Trap, Techno, Pop, Electric, Kawaii, House Energy, Extreme, Bass House – ultimate high-energy mix.",
            // NOVÝ POPIS pre Dark Horror Darkness
            "Dark Horror Darkness": "The ultimate fusion of dark ambient, horror soundtrack, cinematic horror, psychological horror, eerie atmosphere, suspense music, dark cinematic, thriller score, ambient horror, and dark soundtrack elements for maximum tension."
        };

        const container = document.getElementById('genre-container');
        const colorClasses = ["grad-1", "grad-2", "grad-3", "grad-4", "grad-5", "grad-6", "grad-7", "grad-8"];

        // Generate genre cards with dynamic descriptions and color gradients
        for (let i = 0; i < styles.length; i++) {
            const style = styles[i]; 
            const description = descriptions[style] || "This is a long, but fictional description that characterizes the musical genre and its atmosphere. It is just placeholder text to fill the space and make the card look fuller and more professional.";
            const colorClass = colorClasses[i % colorClasses.length];
            
            // Pridanie triedy 'long' pre štýly s dlhým názvom (viac ako 30 znakov)
            const titleClass = style.length > 30 ? 'long' : '';

            const cardHtml = `
                <div class="genre-card ${colorClass}">
                    <h2 class="genre-title ${titleClass}">${style}</h2>
                    <p class="genre-description">${description}</p>
                </div>
            `;
            container.innerHTML += cardHtml;
        }

        // Animation for cards on scroll
        const cards = document.querySelectorAll('.genre-card');
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        cards.forEach(card => {
            observer.observe(card);
        });

        // Chat logic
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const chatBox = document.getElementById('chat-box');
        const loadingSpinner = document.getElementById('loading-spinner');
        const modelToggleButton = document.getElementById('model-toggle');
        const ttsButton = document.getElementById('tts-button');
        const audioPlayer = document.getElementById('audio-player');


        let currentModel = MODEL_STATES.STANDARD; // Začíname so V1 (Štandard)
        let lastGeneratedText = ""; // Uloží posledný AI text pre TTS

        // Funkcia na prepínanie modelov
        const toggleModelMode = () => {
            currentModel = (currentModel + 1) % 3; // Cyklus 0 -> 1 -> 2 -> 0
            
            modelToggleButton.classList.remove('standard', 'energy', 'boosted');

            switch (currentModel) {
                case MODEL_STATES.STANDARD:
                    modelToggleButton.textContent = 'Aktuálny Model: V1';
                    modelToggleButton.classList.add('standard');
                    break;
                case MODEL_STATES.ENERGY:
                    modelToggleButton.textContent = 'Aktuálny Model: V4 Energy (EDM/Trap)';
                    modelToggleButton.classList.add('energy');
                    break;
                case MODEL_STATES.BOOSTED:
                    modelToggleButton.textContent = 'Aktuálny Model: V5 Pro (Bass Boosted)';
                    modelToggleButton.classList.add('boosted');
                    break;
            }
        };

        // Event listener pre prepínanie modelov
        modelToggleButton.addEventListener('click', toggleModelMode);


        // --- FIREBASE API KEY & CONFIG (DUMMY/PLACEHOLDER) ---
        const apiKey = "AIzaSyDdiCiIfr2gLtsRMENBkWG1hJo6N1uij7w"; // Canvas poskytne v runtime
        
        // Funkcia pre exponenciálny backoff
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Funkcie pre konverziu PCM na WAV (vyžadované pre TTS)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, 1, true); // Monophonic
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // byte rate
            view.setUint16(32, 2, true); // block align
            view.setUint16(34, 16, true); // bits per sample

            // data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);

            // PCM data (Int16)
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Funkcia na prečítanie posledného vygenerovaného textu
        const generateTts = async (text) => {
            if (!text) {
                console.error("No text available for TTS.");
                return;
            }

            ttsButton.textContent = 'Generujem Hlas...';
            ttsButton.disabled = true;
            audioPlayer.pause();
            audioPlayer.src = '';
            
            const payload = {
                contents: [{
                    parts: [{ text: `Say with a high-energy, exciting, and melodic tone: ${text}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" } // Upbeat voice
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await exponentialBackoffFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    // API vracia signed PCM16 audio dáta.
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                    ttsButton.textContent = 'Prehrávam Hlas...';
                } else {
                    console.error("TTS response missing audio data or invalid mime type.");
                    ttsButton.textContent = 'Chyba TTS!';
                }

            } catch (error) {
                console.error("Error generating TTS:", error);
                ttsButton.textContent = 'Chyba TTS!';
            } finally {
                ttsButton.disabled = false;
                if(audioPlayer.paused && audioPlayer.src) {
                     // Ak nie je chyba a prehrávanie sa nespustilo hneď, zobraziť "Prečítať"
                    ttsButton.textContent = 'Prečítať Hlasom (TTS)';
                }
            }
        };

        // Event listener pre TTS tlačidlo
        ttsButton.addEventListener('click', () => {
             // Očistiť text od sekcií ([Intro], [Drop] atď.)
            const cleanText = lastGeneratedText.replace(/\[.*?\]\n?/g, '').trim();
            generateTts(cleanText);
        });

        audioPlayer.onended = () => {
             ttsButton.textContent = 'Prečítať Hlasom (TTS)';
        };


        // Function to add a message to the chat
        const addMessage = (text, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            
            const textContentDiv = document.createElement('div');
            textContentDiv.classList.add('message-text');
            textContentDiv.innerHTML = text.replace(/\n/g, '<br>');
            messageDiv.appendChild(textContentDiv);

            // Only add a copy button for AI messages
            if (sender === 'ai') {
                lastGeneratedText = text; // Uložiť text pre TTS
                
                const copyButton = document.createElement('button');
                copyButton.textContent = 'Kopírovať';
                copyButton.classList.add('copy-button');
                
                copyButton.addEventListener('click', () => {
                    // Starší, ale spoľahlivejší spôsob kopírovania
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyButton.textContent = 'Skopírované!';
                        copyButton.classList.add('copied');
                        setTimeout(() => {
                            copyButton.textContent = 'Kopírovať';
                            copyButton.classList.remove('copied');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                    }
                    document.body.removeChild(textArea);
                });
                messageDiv.appendChild(copyButton);
            }
            
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        // Function to send a request to the Gemini API
        const generateText = async () => {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) return;

            addMessage(userPrompt, 'user');
            promptInput.value = '';
            
            loadingSpinner.style.display = 'block';
            generateButton.disabled = true;

            // --- Logika prepínania promptov ---
            let systemPrompt = `You are a creative music lyricist. Generate a lyrical narrative that follows the requested structure.`;
            
            if (currentModel === MODEL_STATES.ENERGY) {
                // V4 Energy: Zameranie na EDM, Trap, Hardcore EDM
                systemPrompt = `You are 'Model V4 Energy', specializing in hyper-fast, high-energy, and aggressive EDM, Hardcore EDM, and Trap lyrics. Your style should be focused on speed, chaotic raves, unstoppable rhythm, pure energy, and massive drops. Use high-octane, intense, and dramatic language. Always follow the requested structure.`;
            } else if (currentModel === MODEL_STATES.BOOSTED) {
                // V5 Pro: Zameranie na Bass Boosted (EDM, Pop) - BEZ VULGARIZMOV
                systemPrompt = `You are 'Model V5 Pro', specializing in powerful, heavy, and extremely bass-boosted music lyrics, including styles like **Bass Boosted (general), EDM Bass Boosted, and Pop Bass Boosted**. Your lyrics must emphasize the **physical feeling of deep sub-bass, heavy sound system energy, ground-shaking vibrations, and sonic distortion**. Focus on the intensity of the sound without using any explicit or vulgar language. Always follow the requested structure.`;
            }

            const structuredPrompt = `Generate a musical lyrical narrative based on the user's idea. The output must follow this exact structure, including the section titles in brackets:

[Intro]
A brief, atmospheric opening.
[Verse 1]
Develop the first part of the story or theme.
[Build-up]
Increase tension or energy, leading into the main section.
[Drop]
The climactic, most impactful part of the song (For V4/V5, this should be the peak of power/chaos).
[Verse 2]
Further develop the narrative or introduce a new perspective.
[Bridge]
A contrasting section that provides a change of pace or mood.
[Final Build]
A second build that brings the song towards its conclusion.
[Final Drop]
The final, powerful conclusion of the song, often with a final line or a sound effect.

User's idea: ${userPrompt}
`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: structuredPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await exponentialBackoffFetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiText) {
                    addMessage(aiText, 'ai');
                } else {
                    addMessage("Ľutujem, nepodarilo sa mi vygenerovať odpoveď. Skúste to prosím znova.", 'ai');
                }

            } catch (error) {
                console.error("Error generating content:", error);
                addMessage("Vyskytla sa chyba pri komunikácii s AI modelom. Skúste to prosím znova.", 'ai');
            } finally {
                loadingSpinner.style.display = 'none';
                generateButton.disabled = false;
            }
        };

        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !generateButton.disabled) {
                generateText();
            }
        });
        generateButton.addEventListener('click', generateText);


        // --- LOGIKA 3D TAPETY (Three.js) - Kozmické a Magické Režimy ---

        const canvas = document.getElementById('threejs-canvas');
        const toggleButton = document.getElementById('toggle-wallpaper');

        // Deklarácia globálnych premenných
        let scene, camera, renderer, particles, geometry, material, torusKnot, pointLight, planet1, planet2;
        let currentWallpaperMode = 'nebula'; // Predvolený režim
        let clock = new THREE.Clock();

        function initThreeJS() {
            // 1. Scéna
            scene = new THREE.Scene();

            // 2. Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0); // Priehľadné pozadie

            // Osvetlenie
            const ambientLight = new THREE.AmbientLight(0x404040, 10); 
            scene.add(ambientLight);
            
            // Bodové svetlo pre Torus Knot (Magický Uzol)
            pointLight = new THREE.PointLight(0x7DE2D1, 15, 100);
            pointLight.position.set(5, 5, 5);
            pointLight.visible = false; 
            scene.add(pointLight);

            createCosmicNebula(); // Inicializácia predvoleného režimu
            animate(); // Spustenie animačnej slučky
            
            // Nastavenie pre zmenu veľkosti okna
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Pomocná funkcia na čistenie scény
        function clearScene() {
            const removableObjects = [];
            scene.traverse(object => {
                if (object.type === 'Mesh' || object.type === 'Points') {
                    removableObjects.push(object);
                }
            });
            removableObjects.forEach(object => {
                scene.remove(object);
                if (object.geometry) object.geometry.dispose();
                if (object.material) {
                    if (Array.isArray(object.material)) {
                        object.material.forEach(m => m.dispose());
                    } else {
                        object.material.dispose();
                    }
                }
            });
        }

        // Režim 1: Kozmická Hmla (Cosmic Nebula Mode) s planétami
        function createCosmicNebula() {
            clearScene();

            // Vytvorenie galaxie/častíc
            geometry = new THREE.BufferGeometry();
            const vertices = [];
            const particleCount = 15000;

            for (let i = 0; i < particleCount; i++) {
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                const z = (Math.random() - 0.5) * 200;
                vertices.push(x, y, z);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            material = new THREE.PointsMaterial({
                size: 0.05,
                color: 0x8888ff,
                transparent: true,
                opacity: 0.8,
                sizeAttenuation: true
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // Vytvorenie dvoch planét pre vizuálny záujem
            const sphereGeometry = new THREE.SphereGeometry(0.5, 32, 32);

            // Planéta 1 (Modrý plyn)
            const material1 = new THREE.MeshPhongMaterial({ color: 0x51A8E8, emissive: 0x111133, shininess: 50 });
            planet1 = new THREE.Mesh(sphereGeometry, material1);
            planet1.position.set(-3, 1, -10);
            scene.add(planet1);

            // Planéta 2 (Purpurová skala)
            const material2 = new THREE.MeshStandardMaterial({ color: 0xD18CEB, metalness: 0.9, roughness: 0.1, emissive: 0x221133 });
            planet2 = new THREE.Mesh(sphereGeometry, material2);
            planet2.position.set(3, -2, -8);
            scene.add(planet2);

            if (pointLight) pointLight.visible = false;
            currentWallpaperMode = 'nebula';
            toggleButton.textContent = 'Zmeniť Tapetu (Nebula)';
        }

        // Režim 2: Magický Uzol (Magic Torus Mode)
        function createMagicTorus() {
            clearScene();

            // Geometria a materiál pre Torus Knot
            const torusGeometry = new THREE.TorusKnotGeometry(1.5, 0.4, 150, 20);
            
            // Magický, žiarivý materiál
            const torusMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xff00ff, // Fialová farba
                metalness: 0.9,
                roughness: 0.1,
                clearcoat: 1.0,
                clearcoatRoughness: 0.1,
                emissive: 0xaa00aa, // Žiara
                emissiveIntensity: 0.8
            });
            torusKnot = new THREE.Mesh(torusGeometry, torusMaterial);
            scene.add(torusKnot);

            // Nastavenie bodového svetla
            if (pointLight) {
                pointLight.color.setHex(0x7DE2D1);
                pointLight.intensity = 20;
                pointLight.visible = true;
            }

            currentWallpaperMode = 'torus';
            toggleButton.textContent = 'Zmeniť Tapetu (Torus)';
        }

        // Funkcia na prepínanie režimov
        toggleButton.addEventListener('click', () => {
            if (currentWallpaperMode === 'nebula') {
                createMagicTorus();
            } else {
                createCosmicNebula();
            }
        });


        // Animačná slučka
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (currentWallpaperMode === 'nebula') {
                // Rotácia častíc
                if (particles) {
                    particles.rotation.y += 0.0005 * delta * 60;
                }
                // Rotácia planét
                if (planet1) {
                    planet1.rotation.y += 0.005 * delta * 60;
                    planet1.position.x = Math.sin(clock.elapsedTime * 0.1) * 3;
                    planet1.position.y = Math.cos(clock.elapsedTime * 0.1) * 1.5;
                }
                if (planet2) {
                    planet2.rotation.z -= 0.008 * delta * 60;
                    planet2.position.z = -8 + Math.sin(clock.elapsedTime * 0.2) * 1;
                }

            } else if (currentWallpaperMode === 'torus') {
                // Rotácia Torus Knot
                if (torusKnot) {
                    torusKnot.rotation.x += 0.005 * delta * 60;
                    torusKnot.rotation.y += 0.01 * delta * 60;
                    torusKnot.rotation.z += 0.007 * delta * 60;
                }
                // Pohyb bodového svetla
                if (pointLight) {
                    pointLight.position.x = Math.sin(clock.elapsedTime * 0.5) * 5;
                    pointLight.position.y = Math.cos(clock.elapsedTime * 0.5) * 5;
                }
            }

            renderer.render(scene, camera);
        }

        // Inicializácia pri načítaní okna
        window.onload = function () {
            initThreeJS();
        }
    </script>
</body>
</html>












